import pandas as pd
from sklearn.ensemble import RandomForestRegressor
import joblib

# Set BASE_SERVINGS (you forgot this in your script before)
BASE_SERVINGS = 2

# Load your recipe Excel
xls = pd.read_excel("recipe_data.xlsx", sheet_name=None, engine="openpyxl")

data = []

# Extract features: original quantity, servings → adjusted amount
for sheet_name, df in xls.items():
    for idx, row in df.iterrows():
        for col in df.columns:
            if "ingredient" in col.lower():
                ingredients = str(row[col]).split("\n")
                for line in ingredients:
                    parts = line.split(" ")
                    if not parts or parts[0].strip() == '':
                        continue
                    try:
                        qty = float(eval(parts[0])) if parts[0].replace(".", "").replace("/", "").isdigit() else 1
                        servings = BASE_SERVINGS
                        data.append([qty, servings, qty])  # Placeholder logic: Adjust if you have real data
                    except:
                        continue

df_final = pd.DataFrame(data, columns=["original_qty", "servings", "adjusted_qty"])

X = df_final[["original_qty", "servings"]]
y = df_final["adjusted_qty"]

model = RandomForestRegressor()
model.fit(X, y)

# ✅ Save the model using joblib
joblib.dump(model, "ingredient_scaler.pkl")
print("✅ ingredient_scaler.pkl created successfully.")
